---
import TestimonialCard from "./TestimonialCard.astro";

const testimonials = [
  {
    text: "In capital letters....THIS GAME IS AWESOME...where has it been all my life...",
    author: "Zeriana William",
    date: "January 4, 2025",
    image: "https://placehold.co/100x100/333/fff?text=ZW",
    rating: 5,
  },
  {
    text: "It's a very good game I love it",
    author: "Enerst Yiadom Boakye",
    date: "October 12, 2025",
    image: "https://placehold.co/100x100/555/fff?text=EB",
    rating: 5,
  },
  {
    text: "it's very claim to play I like it ðŸ¤˜ðŸ¤˜ðŸ¤˜ðŸ‘‹ðŸ‘‹",
    author: "Thandolwethu Caleni",
    date: "October 8, 2025",
    image: "https://placehold.co/100x100/777/fff?text=TC",
    rating: 5,
  },
  {
    text: "I enjoy playing with the game",
    author: "jude zirta",
    date: "September 11, 2025",
    image: "https://placehold.co/100x100/999/fff?text=JZ",
    rating: 4,
  },
  {
    text: "This game is very fun and relaxing ðŸ˜ŒðŸ˜Ž",
    author: "Hamdha Azran",
    date: "July 25, 2025",
    image: "https://placehold.co/100x100/222/fff?text=HA",
    rating: 5,
  },
];
---

<section class="py-24 bg-transparent relative">
  <div class="absolute inset-0 bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-secondary/10 to-transparent pointer-events-none"></div>
  
  <div class="container mx-auto px-4 relative z-10">
    <div class="text-center mb-16">

    <div class="text-center mb-16">
        <h2
          class="text-4xl md:text-5xl font-black text-white mb-4 uppercase italic"
        >
          Ratings and reviews
        </h2>
        <div class="w-24 h-1 bg-gradient-to-r from-primary to-accent mx-auto">
        </div>
      </div>

    <div class="relative max-w-full mx-auto">
      
      <div
        id="testimonial-slider"
        class="flex gap-4 md:gap-8 overflow-x-auto snap-x snap-mandatory pb-12 px-4 scroll-smooth scrollbar-hide cursor-grab active:cursor-grabbing select-none items-center opacity-0 transition-opacity duration-500"
        style="scrollbar-width: none; -ms-overflow-style: none;"
      >
        <div class="shrink-0 w-[5vw] md:w-[30%]"></div>

        {
          testimonials.map((testimonial, index) => (
            <div 
              class="flex-shrink-0 testimonial-wrapper transition-all duration-500 ease-out opacity-40 scale-90 blur-[1px]" 
              data-index={index}
            >
              <div class="pointer-events-none">
                 <TestimonialCard {...testimonial} />
              </div>
            </div>
          ))
        }

        <div class="shrink-0 w-[5vw] md:w-[30%]"></div>
      </div>

      <div class="flex justify-center -mt-4">
        <div class="flex items-center gap-3 bg-black/40 backdrop-blur-md px-6 py-3 rounded-full border border-white/10 shadow-2xl">
          {testimonials.map((_, index) => (
            <button
              aria-label={`Go to slide ${index + 1}`}
              class="dot-btn h-2 rounded-full transition-all duration-300 w-2 bg-white/30 hover:bg-white/60"
              data-index={index}
            />
          ))}
        </div>
      </div>

    </div>
  </div>
</section>

<style>
  .testimonial-wrapper.active-card {
    opacity: 1 !important;
    transform: scale(1.0) !important;
    filter: blur(0) !important;
    z-index: 10;
  }
  
  .dot-btn.active-dot {
    width: 2rem;
    background-color: theme('colors.primary.DEFAULT');
    box-shadow: 0 0 15px theme('colors.primary.DEFAULT');
  }
</style>

<script>
  const slider = document.getElementById("testimonial-slider") as HTMLElement;
  const dots = document.querySelectorAll(".dot-btn") as NodeListOf<HTMLElement>;
  const wrappers = document.querySelectorAll(".testimonial-wrapper") as NodeListOf<HTMLElement>;

  if (slider) {
    // Ø¯Ø§Ù„Ø© Ù„ØªÙ…Ø±ÙƒØ² Ø£ÙŠ Ø¨Ø·Ø§Ù‚Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù€ index
    const scrollToIndex = (index: number, behavior: ScrollBehavior | 'instant' | 'smooth' | 'auto' = 'smooth') => {
    const targetWrapper = wrappers[index];
    if (!targetWrapper) return;

    const sliderWidth = slider.clientWidth;
    const wrapperWidth = targetWrapper.clientWidth;
    const targetLeft = targetWrapper.offsetLeft;

    const scrollPos = targetLeft - (sliderWidth / 2) + (wrapperWidth / 2);

    slider.scrollTo({
        left: scrollPos,
        // TypeScript ÙŠÙ‚Ø¨Ù„ Ø§Ù„Ø¢Ù† 'behavior' ÙƒÙ†ÙˆØ¹ ØµØ­ÙŠØ­
        behavior: behavior
    });
};

    // ----------------------------------------------------
    // 1. Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¨Ø¯Ø¡ Ù…Ù† Ø§Ù„Ù…Ù†ØªØµÙ (Start at Middle Logic)
    // ----------------------------------------------------
    const initSlider = () => {
        // Ø­Ø³Ø§Ø¨ Ø§Ù„ÙÙ‡Ø±Ø³ Ø§Ù„Ø£ÙˆØ³Ø· (Ù…Ø«Ù„Ø§Ù‹ Ù„Ùˆ 5 Ø¨Ø·Ø§Ù‚Ø§ØªØŒ Ø§Ù„Ù†Ø§ØªØ¬ 2)
        const middleIndex = Math.floor(wrappers.length / 2);
        
        // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ ÙÙˆØ±Ø§Ù‹ Ø¨Ø¯ÙˆÙ† Ø§Ù†ÙŠÙ…ÙŠØ´Ù† Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
        scrollToIndex(middleIndex, 'instant');

        // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø³Ù„ÙŠØ¯Ø± Ø¨Ø¹Ø¯ Ø¶Ø¨Ø· Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù„Ù…Ù†Ø¹ Ø§Ù„ÙˆÙ…ÙŠØ¶ (Flicker)
        requestAnimationFrame(() => {
            slider.classList.remove('opacity-0');
            updateActiveState();
        });
    };

    // ØªÙ†ÙÙŠØ° Ø§Ù„Ø¨Ø¯Ø¡ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ø¶Ù…Ø§Ù† ØµØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø³Ø§Øª
    window.addEventListener('load', initSlider);


    // ----------------------------------------------------
    // 2. Ù…Ù†Ø·Ù‚ Ø§Ù„Ø³Ø­Ø¨ (Drag)
    // ----------------------------------------------------
    let isDown = false;
    let startX : number;
    let scrollLeft : number;

    slider.addEventListener('mousedown', (e) => {
      isDown = true;
      slider.style.scrollSnapType = 'none'; 
      slider.style.cursor = 'grabbing';
      startX = e.pageX - slider.offsetLeft;
      scrollLeft = slider.scrollLeft;
    });

    slider.addEventListener('mouseleave', () => {
      isDown = false;
      slider.style.cursor = 'grab';
      slider.style.scrollSnapType = 'x mandatory';
    });

    slider.addEventListener('mouseup', () => {
      isDown = false;
      slider.style.cursor = 'grab';
      slider.style.scrollSnapType = 'x mandatory';
    });

    slider.addEventListener('mousemove', (e) => {
      if (!isDown) return;
      e.preventDefault();
      const x = e.pageX - slider.offsetLeft;
      const walk = (x - startX) * 2;
      slider.scrollLeft = scrollLeft - walk;
    });

    // ----------------------------------------------------
    // 3. Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØ­Ø¯ÙŠØ« (Active State)
    // ----------------------------------------------------
    const updateActiveState = () => {
      const sliderRect = slider.getBoundingClientRect();
      const sliderCenter = sliderRect.left + sliderRect.width / 2;
      let closestIndex = 0;
      let minDistance = Number.MAX_VALUE;

      wrappers.forEach((wrapper, index) => {
        const rect = wrapper.getBoundingClientRect();
        const center = rect.left + rect.width / 2;
        const distance = Math.abs(sliderCenter - center);

        if (distance < minDistance) {
          minDistance = distance;
          closestIndex = index;
        }
      });

      wrappers.forEach((wrapper, i) => {
        if (i === closestIndex) wrapper.classList.add('active-card');
        else wrapper.classList.remove('active-card');
      });

      dots.forEach((dot, i) => {
        if (i === closestIndex) dot.classList.add('active-dot');
        else dot.classList.remove('active-dot');
      });
    };

    slider.addEventListener('scroll', () => window.requestAnimationFrame(updateActiveState));

    // ----------------------------------------------------
    // 4. Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ù†Ù‚Ø§Ø·
    // ----------------------------------------------------
    dots.forEach((dot) => {
      dot.addEventListener("click", (e) => {
        const index = parseInt((e.target as HTMLElement).dataset.index || "0");
        scrollToIndex(index, 'smooth');
      });
    });
  }
</script>